<?php 
$this->headLink()
    ->appendStylesheet('/assets/uniform/css/uniform.default.css')
    ->appendStylesheet('/assets/data-tables/DT_bootstrap.css');

$this->inlineScript()
    ->appendFile('/assets/uniform/jquery.uniform.min.js')
    ->appendFile('/js/jquery.blockui.js')
    ->appendFile('/assets/data-tables/jquery.dataTables.js')
    ->appendFile('/assets/data-tables/DT_bootstrap.js')
    ->appendFile('/js/dynamic-table/project.js');

$closed = (($project->getStatus()->getHalt()==1) && ($project->getStatus()->getWeighting()==0));
$job = false;



?>
<?php 
$notes = $project->getNotes();
if (!empty($notes)) {
    $notesArr  = json_decode($notes);
    if (!empty($notesArr)) {
?>
<div class="row-fluid">
    <div class="span12">
        <div class="alert alert-info">
            <button class="close" data-dismiss="alert">Ã—</button>
<?php
        $cnt = 0;
        foreach ($notesArr as $note) {
            $cnt++;
            echo (($cnt>1)?'<br />':'')."<strong>Note {$cnt}:</strong> {$note}.";
            
        }
?>
        </div>
    </div>
</div>
<?php
    }
}
?>
<?php
if ($project->getTest()) {
  ?>
<div class="row-fluid">
    <div class="span12">
        <div class="alert alert-error">
            <strong>Important Notice:</strong> this project is in test mode and will not show up on reporting. Material generated from this project should not be presented to the client.
        </div>
    </div>
</div>
<?php
}
?>
<div class="row-fluid">
    <div class="span12">
        <div class="row-fluid">
            <a class="icon-btn span2" href="/client-<?php echo $project->getClient()->getClientId(); ?>/project-<?php echo $project->getProjectId(); ?>/setup/">
                <i class="icon-gears"></i>
                <div>Configuration  </div>
                <span class="badge badge-important">2</span>
            </a>
            <a class="icon-btn span2" href="/client-<?php echo $project->getClient()->getClientId(); ?>/project-<?php echo $project->getProjectId(); ?>/system/">
                <i class="icon-sitemap"></i>
                <div>System Setup</div>
            </a>
            <a class="icon-btn span2" href="/client-<?php echo $project->getClient()->getClientId(); ?>/project-<?php echo $project->getProjectId(); ?>/model/">
                <i class="icon-bar-chart"></i>
                <div>Model</div>
                <span class="badge badge-success">4</span>
            </a>
            <a class="icon-btn span2" href="#">
                <i class="icon-group"></i>
                <div>Collaborators  </div>
                <span class="badge badge-important">0</span>
            </a>
            <a class="icon-btn span2" href="#">
                <i class="icon-reorder"></i>
                <div>Reports</div>
            </a>
            <a class="icon-btn span2" href="#">
                <i class="icon-calendar"></i>
                <div>Calendar</div>
                <span class="badge badge-success">4</span>
            </a>
        </div>
        <!-- BEGIN BLOG PORTLET-->
        <div class="row-fluid">
            <div class="blog">
                <div class="span2 <?php echo $closed?'red':($job?'green':'green'); ?>">
                    <a href="javascript:;" class="blog-features date active">
                        <i class=" icon-<?php echo $closed?'ban-circle':($job?'ok':'time'); ?>"></i>
                        <p class="month"><?php echo $closed?'lost':($job?'job':'active'); ?></p>
                    </a>
                    <a href="/client-<?php echo $project->getClient()->getClientId(); ?>/project-<?php echo $project->getProjectId(); ?>/system/" class="blog-features comments">
                        <i class=" icon-gear"></i>
                        <p class="info"><?php echo (empty($system)?0:count($system)); ?> Products</p>
                    </a>
                    <a href="javascript:;" class="blog-features comments">
                        <i class=" icon-file-text"></i>
                        <p class="info">0 Proposals</p>
                    </a>
                    <a href="javascript:;" class="blog-features comments">
                        <i class=" icon-info"></i>
                        <p class="info"><?php echo str_pad($project->getClient()->getClientId(), 5, "0", STR_PAD_LEFT),'-',str_pad($project->getProjectId(), 5, "0", STR_PAD_LEFT) ?></p>
                    </a>
                </div>
                <div class="span10">
                    <h2>
                        <?php echo $project->getName(); ?>
                    </h2>
                    <p>
                        OWNER <a href="javascript:;" class="author"><?php echo strtoupper($project->getClient()->getUser()->getHandle()); ?></a> |  CREATED: <?php echo $project->getcreated()->format('d/m/Y H:i'); ?>
                    </p>
                    <h5>Weighting<span class="pull-right"><?php echo $project->getWeighting(); ?>%</span></h5>
                    <div id="slider-range-min" class="slider"></div>
                    <div class="progress progress-striped progress-<?php
                        if ($project->getWeighting()<10) {
                            echo 'danger';
                        } elseif ($project->getWeighting()<30) {
                            echo 'warning';
                        } elseif ($project->getWeighting()<50) {
                            echo 'info';
                        } elseif ($project->getWeighting()<80) {
                            echo 'striped';
                        } else {
                            echo 'success';
                        }

                    ?>">
                        <div style="width: <?php echo $project->getWeighting(); ?>%;" class="bar"></div>
                    </div>
                    <p> Below are displayed the details of the project including information about the LED 
                        systems that are planned and a file management section in which project files can be managed. </p>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th colspan="2">
                                    Project Information
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="width: 120px">
                                    Project Status
                                </td>
                                <td>
                                    <?php 
                                        echo '<span class="label label-'.(($project->getStatus()->getweighting()==0)?(($project->getStatus()->gethalt()==1)?'important':'info'):'success').' label-mini">'.ucwords($project->getStatus()->getName()).'</span>';
                                     ?>
                                    <a class="label label-info" style="float: right"><i class=" icon-cog"></i></a>
                                </td>
                            </tr>
                            <tr>
                                <td rowspan="3" style="width: 120px">
                                    Primary Contact
                                </td>
                                <td>
                                    <?php 
                                        /*if ($this->getAction()->primaryContact instanceof _DB_Contact) {
                                        echo $this->getAction()->primaryContact->getName(); 
                                        } else {
                                            echo 'not specified';
                                        }/**/
                                    ?>&nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <?php 
                                    /*if ($this->getAction()->primaryContact instanceof _DB_Contact) {
                                        echo ($this->getAction()->primaryContact->hasTelephone1()?$this->getAction()->primaryContact->getTelephone1():'No Telephone Found');
                                        } else {
                                            echo 'not specified';
                                        }
                                     /**/?>&nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <?php 
                                    /*if ($this->getAction()->primaryContact instanceof _DB_Contact) {
                                        echo ($this->getAction()->primaryContact->hasEmail()?$this->getAction()->primaryContact->getEmail():'No Email Found');
                                        } else {
                                            echo 'not specified';
                                        }/**/
                                     ?>&nbsp;
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 120px">
                                    Project Value
                                </td>
                                <td>&#163;
                                    <?php 
                                        //echo number_format($this->getAction()->costs['total_cost'], 2);
                                     ?>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- END BLOG PORTLET-->
        
    </div>
</div>
<div class="row-fluid">
    <div class="span12">
        <!-- BEGIN BASIC PORTLET-->
        <div class="widget orange">
            <div class="widget-title">
                <h4><i class="icon-cogs"></i> System Overview</h4>
            <span class="tools">
                <a href="javascript:;" class="icon-chevron-down"></a>
            </span>
            </div>
            <div class="widget-body">
                <table class="table table-striped table-bordered table-advance table-hover" id="products_tbl">
                    <thead>
                        <tr>
                            <th ><i class="icon-cog"></i> Product Name</th>
                            <th class="hidden-phone"> Product Type</th>
                            <th class="hidden-phone" style="width: 40px"> ECA</th>
                            <th style="width: 110px"> Quantity</th>
                            <th style="width: 140px"> Price (inc MCD)</th>
                        </tr>
                    </thead>
                    <tbody>
<?php
    $totalPriceMCD = 0;
    $totalQuantity = 0;
    if (!empty($system)) {
        $mcd = $project->getMCD();
        foreach ($system as $product) {
            $priceMCD = round($product['price'] * (1-$mcd), 2);
            $totalPriceMCD+=$priceMCD;
            $totalQuantity+=$product['quantity'];
            
            echo '<tr>
                    <td>'.$product['model'].'</td>
                    <td>'.$product['productType'].'</td>
                    <td>'.(($product['eca']==1)?'<span class="label label-success"><i class=" icon-ok"></i></span>':'<span class="label label-important"><i class=" icon-ban-circle"></i></span>').'</td>
                    <td class="row-right">'.$product['quantity'].'</td>
                    <td class="row-right">'.number_format($priceMCD,2).'</td>
                </tr>';
        }
    }/**/
?>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">TOTAL</th>
                            <td class="row-right"><?php echo $totalQuantity; ?></td>
                            <th class="row-right">&#163;<?php echo number_format($totalPriceMCD,2); ?></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <!-- END BASIC PORTLET-->
    </div>
</div>
<div class="row-fluid">
     <div class="span6">
         <!-- BEGIN NOTIFICATIONS PORTLET-->
         <div class="widget blue">
             <div class="widget-title">
                 <h4><i class="icon-bell"></i> Project Activity </h4>
               <span class="tools">
                   <a href="javascript:;" class="icon-chevron-down"></a>
                   <a href="javascript:;" class="icon-remove"></a>
               </span>
             </div>
             <div class="widget-body">
                 <ul class="item-list scroller padding"  style="overflow: hidden; width: auto; height: 320px;" data-always-visible="1">
                     <?php
                        if (!empty($audit)) {
                            $i=0;
                            foreach ($audit as $aItem) {
                                $tm = (time()-$aItem['created']->getTimestamp());
                                $days = floor(($tm/(60*60*24)));
                                $hours = ($tm - ($days*60*60*24))/(60*60);
                                $when= (($tm/60)<2)
                                        ?'Just now'
                                        :(
                                            (($tm/60)<60)
                                            ?ceil($tm/60).' mins ago'
                                            :(
                                                ($days<1)
                                                ?floor($hours).' hour'.(($hours>=2)?'s':'').' ago'
                                                :$days.' day'.(($days>=2)?'s':'').' '.(
                                                    ($hours>0)
                                                    ?floor($hours).' hour'.(($hours>=2)?'s':'').' '
                                                    :''
                                                ).'ago'    
                                            )
                                        );
                                
                                $tooltip_data = '';
                                $tooltip = '';
                                $url = '';
                                
                                $aData = json_decode($aItem['data'], true);
                                
                                if (!empty($aItem['dName'])) {
                                    $tooltip_data.=$aItem['dName'];
                                    if (!empty($aItem['projectId'])) {
                                        $url = '/client-'.$aItem['clientId'].'/project-'.$aItem['projectId'].'/document/index/';
                                    }
                                } elseif (!empty($aItem['model'])) {
                                    $tooltip_data.=trim($aItem['model']);
                                    $url = '/client-'.$aItem['clientId'].'/project-'.$aItem['projectId'].'/space-'.$aItem['spaceId'].'/';
                                } elseif (!empty($aItem['sName'])) {
                                    $tooltip_data.=$aItem['sName'];
                                    $url = '/client-'.$aItem['clientId'].'/project-'.$aItem['projectId'].'/space-'.$aItem['spaceId'].'/';
                                } 
                                
                                if (!empty($tooltip_data)) {
                                    $tooltip = 'data-trigger="hover" data-placement="right" data-original-title="'.$tooltip_data.'"';
                                }
                                
                                
                                
                                //break;
                                echo '<li>
                                    <span '.$tooltip.' class="audit '.(empty($tooltip)?'':'tooltips ').'label label-'.(empty($aItem['box'])?'success':$aItem['box']).'" '
                                        . (!empty($url)?'data-url="'.$url.'" data-link="true"':'')
                                    . '><i '
                                        . 'class="icon-'.(empty($aItem['icon'])?'bell':$aItem['icon']).'"></i></span>
                                    <span class="link">'.
                                        $aItem['atName'].
                                    '</span>
                                    <div class="pull-right">
                                        <span class="small italic ">'.$when.'</span>
                                    </div>
                                </li>';
                            } 
                        } else {
                             echo '<li>
                                    <span class="label label-default"><i class="icon-bell"></i></span>
                                    <span class="link">No Activity Information Found</span>
                                    <div class="pull-right">
                                        <span class="small italic ">&nbsp;</span>
                                    </div>
                                </li>';
                        }
                    ?>  
                 </ul>
                 <div class="space10"></div>
                 <a href="#" class="pull-right">View detailed notifications</a>
                 <div class="clearfix no-top-space no-bottom-space"></div>
             </div>
         </div>
         <!-- END NOTIFICATIONS PORTLET-->
     </div>
     <div class="span6">
         <!-- BEGIN CHAT PORTLET-->
         <?php echo $this->partial('partial/panels/activity.phtml'); ?>
         <!-- END CHAT PORTLET-->
     </div>
 </div>
